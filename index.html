<!doctype html>
<html>
    <head>
        <title></title>
        <meta charset="utf-8" />
        <script type="text/javascript" src="helpers.js"></script>
        <script type="text/javascript" src="agua.js"></script>
        <script type="text/javascript" src="bower_components/chart.js/dist/Chart.min.js"></script>
        <link rel="stylesheet"
              href="bower_components/chartist/dist/chartist.min.css">

        <script type="text/javascript" src="mychart.js"></script>

        <style>
         input {
             width:100px;
             text-align:right;
         }

         .wrapper {
             display: grid;
             grid-template-columns: 350px 100%;
             grid-gap: 10px;
             /* background-color: #fff;
                color: #444; */
         }

         .box {
             /* background-color: #444;
                color: #fff; */
             border-radius: 5px;
             padding: 20px;
             /*              font-size: 150%; */
         }
        </style>
    </head>
    <body>
        <table><tbody>
            <tr>
                <td>Consumo Médio (m3)</td>
                <td><input name="consumo" type="number" value="10" min="0" /></td>

                <td>Mínimo Água</td>
                <td><input name="consumo_minimo_agua" type="number" value="10" min="0"/></td>

                <td>Mínimo Esgoto</td>
                <td><input name="consumo_minimo_esgoto" type="number" value="8" min="0"/></td>
            </tr>
            <tr>
                <td>Taxa de contingência: </td>
                <td>
                    <label class="switch">
                        <input name="usar_meta" type="checkbox" checked>
                    </label>
                </td>
                <td id="meta_value_label">Meta:</td>
                <td><input name="meta_value" type="number" value="10" min="0" /></td>

                <td>N° Apartamentos</td>
                <td><input name="numero_apartamentos" type="number" value="180" min="0", max="1000" title="Esse valor é acrescido de 1 para as áreas comuns" /></td>
            </tr>
        </tbody>
        </table>
        <table><tbody>
            <tr>
                <th>Faixa</th>
                <th>Água (m3)</th>
                <th>Água (R$)</th>
                <th>Cont. (m3)</th>
                <th>Cont. (R$)</th>
                <th>Esgoto (m3)</th>
                <th>Esgoto (R$)</th>
            </tr>
            <tr>
                <td>0-10</td>
                <td><input name="faixa-0-10_agua_m3" type="text" value="" disabled/></td>
                <td><input name="faixa-0-10_agua_reais" type="text" value="" disabled/></td>
                <td><input name="faixa-0-10_agua_cont_m3" disabled/></td>
                <td><input name="faixa-0-10_agua_cont_reais" disabled/></td>
                <td><input name="faixa-0-10_esgoto_m3" type="text" value="" disabled/></td>
                <td><input name="faixa-0-10_esgoto_reais" type="text" value="" disabled/></td>
            </tr>
            <tr>
                <td>11-15</td>
                <td><input name="faixa-11-15_agua_m3" type="text" value="" disabled/></td>
                <td><input name="faixa-11-15_agua_reais" type="text" value="" disabled/></td>
                <td><input name="faixa-11-15_agua_cont_m3" disabled/></td>
                <td><input name="faixa-11-15_agua_cont_reais" disabled/></td>
                <td><input name="faixa-11-15_esgoto_m3" type="text" value="" disabled/></td>
                <td><input name="faixa-11-15_esgoto_reais" type="text" value="" disabled/></td>
            </tr>
            <tr>
                <td>16-20</td>
                <td><input name="faixa-16-20_agua_m3" type="text" value="" disabled/></td>
                <td><input name="faixa-16-20_agua_reais" type="text" value="" disabled/></td>
                <td><input name="faixa-16-20_agua_cont_m3" disabled/></td>
                <td><input name="faixa-16-20_agua_cont_reais" disabled/></td>
                <td><input name="faixa-16-20_esgoto_m3" type="text" value="" disabled/></td>
                <td><input name="faixa-16-20_esgoto_reais" type="text" value="" disabled/></td>
            </tr>
            <tr>
                <td>21-50</td>
                <td><input name="faixa-21-50_agua_m3" type="text" value="" disabled/></td>
                <td><input name="faixa-21-50_agua_reais" type="text" value="" disabled/></td>
                <td><input name="faixa-21-50_agua_cont_m3" disabled/></td>
                <td><input name="faixa-21-50_agua_cont_reais" disabled/></td>
                <td><input name="faixa-21-50_esgoto_m3" type="text" value="" disabled/></td>
                <td><input name="faixa-21-50_esgoto_reais" type="text" value="" disabled/></td>
            </tr>
            <tr>
                <td>50+</td>
                <td><input name="faixa-50+_agua_m3" type="text" value="" disabled/></td>
                <td><input name="faixa-50+_agua_reais" type="text" value="" disabled/></td>
                <td><input name="faixa-50+_agua_cont_m3" disabled/></td>
                <td><input name="faixa-50+_agua_cont_reais" disabled/></td>
                <td><input name="faixa-50+_esgoto_m3" type="text" value="" disabled/></td>
                <td><input name="faixa-50+_esgoto_reais" type="text" value="" disabled/></td>
            </tr>
            <tr>
                <td>Soma Individual</td>
                <td><input name="agua_m3_total" type="text" value="" disabled/></td>
                <td><input name="agua_reais_total" type="text" value="" disabled/></td>
                <td><input name="agua_cont_m3_total" disabled/></td>
                <td><input name="agua_cont_reais_total" disabled/></td>
                <td><input name="esgoto_m3_total" type="text" value="" disabled/></td>
                <td><input name="esgoto_reais_total" type="text" value="" disabled/></td>
            </tr>
            <tr>
                <td>Soma Condomínio</td>
                <td><input name="agua_m3_total_condominio" type="text" value="" disabled/></td>
                <td><input name="agua_reais_total_condominio" type="text" value="" disabled/></td>
                <td><input name="agua_cont_m3_total_condominio" disabled/></td>
                <td><input name="agua_cont_reais_total_condominio" disabled/></td>
                <td><input name="esgoto_m3_total_condominio" type="text" value="" disabled/></td>
                <td><input name="esgoto_reais_total_condominio" type="text" value="" disabled/></td>
            </tr>
        </tbody>
        </table>

        <br/>

        <div class="wrapper">
            <div class="box">
                <table><tbody>
                    <tr>
                        <td>Conta Individual:</td>
                        <td><input name="valor_da_conta" type="text" value="" disabled/></td>
                    </tr>
                    <tr>
                        <td>Contingência Individual:</td>
                        <td><input name="contingencia" type="text" value="" disabled/></td>
                    </tr>
                    <tr>
                        <td style="color:red; font-weight: bold;">Conta Total com extra:</td>
                        <td><input name="valor_da_conta_com_contingencia" type="text" value="" disabled/></td>
                    </tr>
                    <tr></tr>
                    <tr></tr>
                    <tr></tr>
                    <tr>
                        <td>Conta do Condomínio:</td>
                        <td><input name="valor_da_conta_condominio" type="text" value="" disabled/></td>
                    </tr>
                    <tr>
                        <td>Contingência do Condomínio:</td>
                        <td><input name="contingencia_condominio" type="text" value="" disabled/></td>
                    </tr>
                    <tr>
                        <td>Conta do Condomínio com extra:</td>
                        <td><input name="valor_da_conta_com_contingencia_condominio" type="text" value="" disabled/></td>
                    </tr>
                </tbody></table>
            </div>

            <div id="myChartContainer" class="box">
                <canvas id="myChartCanvas" width="500" height="300" style="border:1px solid">
            </div>
        </div>



        <script>
         function setElementValue(name, value) {
             document.getElementsByName(name)[0].value = value;
         }

         function setaValoresComputados(nomes, arrayValores) {
             for(let i = 0; i < nomes.length; i++) {
                 setElementValue(nomes[i], arrayValores[i]);
             }
         }

         function onUsarMetaCheckboxChange() {
             if(this.checked) {
                 /* document.getElementsByName("meta_value")[0].disabled = false;*/
                 document.getElementsByName("meta_value")[0].style.visibility = 'visible';
                 document.getElementById("meta_value_label").style.visibility = 'visible';
             }
             else {
                 /* document.getElementsByName("meta_value")[0].disabled = true;*/
                 document.getElementsByName("meta_value")[0].style.visibility = 'hidden';
                 document.getElementById("meta_value_label").style.visibility = 'hidden';
             }
             onConsumoChange();
         }

         function onConsumoChange() {
             let consumo = parseInt(document.getElementsByName("consumo")[0].value);

             let consumo_minimo_agua = parseInt(document.getElementsByName("consumo_minimo_agua")[0].value);
             let consumo_minimo_esgoto = parseInt(document.getElementsByName("consumo_minimo_esgoto")[0].value);;

             let numero_apartamentos = parseInt(document.getElementsByName("numero_apartamentos")[0].value) + 1;

             let numFaixas = 5;
             let nome_faixas = ["faixa-0-10", "faixa-11-15", "faixa-16-20", "faixa-21-50", "faixa-50+"];

             let faixas_agua = quebra_faixas(consumo, consumo_minimo_agua);
             let faixas_esgoto = quebra_faixas(0.8*consumo, consumo_minimo_esgoto);

             let custo_agua_em_faixas = calcula_custo_agua_por_faixa(consumo, consumo_minimo_agua);
             let custo_esgoto_em_faixas = calcula_custo_esgoto_por_faixa(consumo, consumo_minimo_esgoto);

             // xxxxxxxxxx Contingência xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
             let consumo_contingencia_em_faixas;
             let custo_contingencia_somada = 0;
             let custo_agua_contingencia_em_faixas;
             if (document.getElementsByName("usar_meta")[0].checked) {
                 let meta = parseInt(document.getElementsByName("meta_value")[0].value);
                 consumo_contingencia_em_faixas = calcula_consumo_contingencia_por_faixa(consumo, consumo_minimo_agua, meta)

                 custo_agua_contingencia_em_faixas = calcula_custo_agua_excedente_por_faixa(consumo, consumo_minimo_agua, meta);
                 custo_contingencia_somada = somaArray(custo_agua_contingencia_em_faixas);
                 if (custo_contingencia_somada < 0) custo_contingencia_somada = 0;
                 document.getElementsByName("contingencia")[0].value = emReais(custo_contingencia_somada);
                 document.getElementsByName("contingencia_condominio")[0].value = emReais(numero_apartamentos * custo_contingencia_somada);
             }
             else {
                 consumo_contingencia_em_faixas = Array(5).fill(0);
                 custo_agua_contingencia_em_faixas = Array(5).fill(0);
                 document.getElementsByName("contingencia")[0].value = emReais(0);
                 document.getElementsByName("contingencia_condominio")[0].value = emReais(0);
             }
             // xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

             // Seta os valores individuais por faixa
             for(let i=0; i < numFaixas; i++) {
                 setElementValue(nome_faixas[i]+"_agua_m3", faixas_agua[i]);
                 setElementValue(nome_faixas[i]+"_agua_reais", emReais(custo_agua_em_faixas[i]));
                 setElementValue(nome_faixas[i]+"_agua_cont_m3", consumo_contingencia_em_faixas[i]);
                 setElementValue(nome_faixas[i]+"_agua_cont_reais", emReais(custo_agua_contingencia_em_faixas[i]));
                 setElementValue(nome_faixas[i]+"_esgoto_m3", faixas_esgoto[i]);
                 setElementValue(nome_faixas[i]+"_esgoto_reais", emReais(custo_esgoto_em_faixas[i]));
             }

             // Valor total da conta
             let custo_agua_somado = somaArray(custo_agua_em_faixas);
             let custo_esgoto_somado = somaArray(custo_esgoto_em_faixas);
             let custo_agua_e_esgoto_somado = custo_agua_somado + custo_esgoto_somado
             let custo_agua_com_contingencia_e_esgoto_somado = custo_agua_e_esgoto_somado + custo_contingencia_somada
             setElementValue("agua_m3_total", somaArray(faixas_agua));
             setElementValue("agua_reais_total", emReais(custo_agua_somado));
             setElementValue("agua_cont_m3_total", somaArray(consumo_contingencia_em_faixas));
             setElementValue("agua_cont_reais_total", emReais(custo_contingencia_somada));
             setElementValue("esgoto_m3_total", somaArray(faixas_esgoto));
             setElementValue("esgoto_reais_total", emReais(custo_esgoto_somado));


             setElementValue("agua_m3_total_condominio", numero_apartamentos*somaArray(faixas_agua));
             setElementValue("agua_reais_total_condominio", emReais(numero_apartamentos*custo_agua_somado));
             setElementValue("agua_cont_m3_total_condominio", numero_apartamentos*somaArray(consumo_contingencia_em_faixas));
             setElementValue("agua_cont_reais_total_condominio", emReais(numero_apartamentos*custo_contingencia_somada));
             setElementValue("esgoto_m3_total_condominio", numero_apartamentos*somaArray(faixas_esgoto));
             setElementValue("esgoto_reais_total_condominio", emReais(numero_apartamentos*custo_esgoto_somado));

             setElementValue("valor_da_conta", emReais(custo_agua_e_esgoto_somado));
             setElementValue("valor_da_conta_com_contingencia", emReais(custo_agua_com_contingencia_e_esgoto_somado));
             setElementValue("valor_da_conta_condominio", emReais(custo_agua_e_esgoto_somado*numero_apartamentos));
             setElementValue("valor_da_conta_com_contingencia_condominio", emReais(custo_agua_com_contingencia_e_esgoto_somado*numero_apartamentos));
         }

         document.getElementsByName("consumo")[0].addEventListener('change', onConsumoChange);
         document.getElementsByName("consumo_minimo_agua")[0].addEventListener('change', onConsumoChange);
         document.getElementsByName("consumo_minimo_esgoto")[0].addEventListener('change', onConsumoChange);
         document.getElementsByName("meta_value")[0].addEventListener('change', onConsumoChange);
         document.getElementsByName("usar_meta")[0].addEventListener('change', onUsarMetaCheckboxChange);
         document.getElementsByName("numero_apartamentos")[0].addEventListener('change', onConsumoChange);

         onConsumoChange();
        </script>


        <!-- Chart Javascript -->
        <script src="bower_components/chartist/dist/chartist.min.js"></script>

        <script>
         function drawChartFromPage() {
             let consumo_minimo_agua = parseInt(document.getElementsByName("consumo_minimo_agua")[0].value);
             let consumo_minimo_esgoto = parseInt(document.getElementsByName("consumo_minimo_esgoto")[0].value);;
             let meta = parseInt(document.getElementsByName("meta_value")[0].value);
             drawChart(consumo_minimo_agua, consumo_minimo_esgoto, meta);
         }
         document.getElementsByName("consumo_minimo_agua")[0].addEventListener('change', drawChartFromPage);
         document.getElementsByName("consumo_minimo_esgoto")[0].addEventListener('change', drawChartFromPage);
         document.getElementsByName("meta_value")[0].addEventListener('change', drawChartFromPage);

         drawChartFromPage();
        </script>
    </body>
</html>
